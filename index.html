<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PJM Demand: Top 5 Daily Peaks (ET)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f9f9f9;
      color: #333;
    }
    h1 {
      margin-bottom: 1rem;
    }
    #result {
      margin-top: 1rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #loading {
      font-style: italic;
      color: #666;
    }
    .error {
      color: #c00;
      margin-top: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>PJM Demand Top 5 Daily Peaks (ET)</h1>

  <div id="result">
    <div id="loading">Loading PJM data… (check DevTools → Console for raw JSON)</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="output" style="display: none;">
      <table>
        <thead>
          <tr>
            <th>Date (ET)</th>
            <th>Time (ET)</th>
            <th>Value (MW)</th>
          </tr>
        </thead>
        <tbody id="rows-pjm"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ─── 1) Adjust your date‐range here if needed ─────────────────────────
      // Currently: June 4 04:00 UTC → June 11 04:00 UTC
      const url =
        'https://peaks.api.ndustrial.io/demand'
        + '?and=(time.gte.2025-06-04T04%3A00%3A00.000Z,time.lte.2025-06-11T04%3A00%3A00.000Z)'
        + '&region=eq.PJM'
        + '&order=time';

      // ─── 2) Insert your BEARER token (exactly as in your curl) ────────────
      const BEARER_TOKEN = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IjhmRFVxTW1Xb01HelFwOFgifQ…'; 
      // ← Replace with the full token string you use in curl.

      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + BEARER_TOKEN
          // (Browsers supply their own User‐Agent automatically.)
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(rawArray => {
        // ─── 3) Log the *exact* array that the API returned ─────────────────
        console.log('✅ Raw PJM data array:', rawArray);

        if (!Array.isArray(rawArray) || rawArray.length === 0) {
          throw new Error('API returned no data or not an array');
        }

        // ─── 4) Sort by descending “value” (assume units are MW) ───────────────
        // If the API returns value in kW, divide by 1000 here. Adjust if needed.
        rawArray.sort((a, b) => {
          const va = Number(a.value);
          const vb = Number(b.value);
          return vb - va;
        });

        // ─── 5) Pick top 5 entries, each from a different ET date ───────────────
        const seenDatesET = new Set();
        const topFivePeaks = [];

        for (const entry of rawArray) {
          if (topFivePeaks.length >= 5) break;

          // Convert UTC timestamp to an Eastern‐Time date string (MM/DD/YYYY)
          const dtUTC = new Date(entry.time);
          const dateET = dtUTC.toLocaleDateString('en-US', {
            timeZone: 'America/New_York',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });

          if (!seenDatesET.has(dateET)) {
            seenDatesET.add(dateET);

            // Build an ET time component (e.g. “04:00:00 PM”)
            const timeET = dtUTC.toLocaleString('en-US', {
              timeZone: 'America/New_York',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true
            });

            topFivePeaks.push({
              dateET,
              timeET,
              valueMW: Number(entry.value)
            });
          }
        }

        if (topFivePeaks.length === 0) {
          throw new Error('No distinct‐day peaks found in the returned data.');
        }

        // ─── 6) Render the table rows based on the *actual* values ──────────────
        const tbody = document.getElementById('rows-pjm');
        topFivePeaks.forEach(item => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          tdDate.innerText = item.dateET;
          tr.appendChild(tdDate);

          const tdTime = document.createElement('td');
          tdTime.innerText = item.timeET;
          tr.appendChild(tdTime);

          const tdValue = document.createElement('td');
          tdValue.innerText = item.valueMW.toLocaleString(undefined, {
            minimumFractionDigits: 3,
            maximumFractionDigits: 3
          });
          tr.appendChild(tdValue);

          tbody.appendChild(tr);
        });

        // ─── 7) Hide “Loading” and show the table ───────────────────────────────
        document.getElementById('loading').style.display = 'none';
        document.getElementById('output').style.display = 'block';
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        const eDiv = document.getElementById('error');
        eDiv.innerText = 'Error: ' + err.message;
        eDiv.style.display = 'block';
      });
    });
  </script>
</body>
</html>
