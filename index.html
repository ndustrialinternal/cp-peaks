<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coincident Peak Program Current Peaks</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background-color: #f9f9f9; color: #333; }
    h1 { margin-bottom: 0.5rem; }
    h2 { margin-bottom: 1rem; font-size: 0.9rem; color: #555; }
    h3 { margin-top: 2rem; margin-bottom: 0.5rem; }
    section { margin-top: 2rem; padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
    #loading-pjm, #loading-ercot { font-style: italic; color: #666; }
    .error { color: #c00; margin-top: 0.5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; margin-bottom: 1.5rem; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body>
  <button id="alerts-button"
          onclick="window.location.href='https://ndustrialinternal.github.io/amp-cp-alerts/';">
    Open Amp CP Alerts
  </button>

  <!-- PJM Section -->
  <section>
    <h1>PJM Demand Top 5 Daily Peaks by Zone (ET)</h1>
    <div id="loading-pjm">Loading PJM data…</div>
    <div id="error-pjm" class="error" style="display:none;"></div>
    <div id="output-pjm" style="display:none;">
      <div id="tables-pjm"></div>
    </div>
  </section>

  <!-- ERCOT Section (unchanged) -->
  <section>
    <h1>ERCOT Demand Top 5 Intervals per Month (CT)</h1>
    <h2>Top 5 15‑minute intervals each month</h2>
    <div id="loading-ercot">Loading ERCOT data…</div>
    <div id="error-ercot" class="error" style="display:none;"></div>
    <div id="output-ercot" style="display:none;">
      <div id="tables-ercot"></div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_KEY = 'bda3a30f30804e22a62e4637700bab54';

      // PJM via GridStatus: generate top‑5 daily peaks for each zone, using interval_end_local
      (function fetchPJM() {
        const url =
          'https://api.gridstatus.io/v1/datasets/pjm_standardized_hourly/query'
          + '?start_time=2025-06-01T01%3A00%3A00'
          + '&end_time=2025-10-01'
          + '&timezone=market';

        fetch(url, { headers: { 'x-api-key': API_KEY } })
          .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
          .then(resp => {
            const arr = resp.data || [];

            // define the zones and their field keys
            const zones = [
              { key: 'load.pjm_rto', label: 'PJM RTO'      },
              { key: 'load.comed',   label: 'COMED'        },
              { key: 'load.ae',      label: 'AECO'         },
              { key: 'load.aep',     label: 'AEP'          },
              { key: 'load.dpl',     label: 'DPL'          },
              { key: 'load.ps',      label: 'PSEG'         },
              { key: 'load.pe',      label: 'PECO'         },
              { key: 'load.bc',      label: 'BGE'          },
              { key: 'load.pl',      label: 'PPL'          },
            ];

            const container = document.getElementById('tables-pjm');
            container.innerHTML = '';

            zones.forEach(zone => {
              // map each record to { interval_end_local, value }
              const copy = arr.map(e => ({
                interval_end_local: e.interval_end_local,
                value: e[zone.key]
              }));

              // sort descending by value
              copy.sort((a,b) => (b.value||0) - (a.value||0));

              // pick top 5 unique dates, capturing date, day, endTime, value
              const seen = new Set(), top = [];
              for (const e of copy) {
                if (top.length >= 5) break;
                const dt = new Date(e.interval_end_local);
                const date = dt.toLocaleDateString('en-US', {
                  timeZone: 'America/New_York',
                  year: 'numeric', month: '2-digit', day: '2-digit'
                });
                if (!seen.has(date)) {
                  seen.add(date);
                  top.push({
                    date,
                    day: dt.toLocaleDateString('en-US',{weekday:'short',timeZone:'America/New_York'}),
                    endTime: dt.toLocaleTimeString('en-US', {
                      timeZone: 'America/New_York',
                      hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }),
                    value: e.value
                  });
                }
              }

              if (!top.length) return;

              // render header + table
              const h3 = document.createElement('h3');
              h3.innerText = zone.label;
              container.appendChild(h3);

              const tbl = document.createElement('table');
              const thead = document.createElement('thead');
              const headerRow = document.createElement('tr');
              ['Date (ET)','Day','End Time (ET)','Load (MW)']
                .forEach(txt => {
                  const th = document.createElement('th');
                  th.innerText = txt;
                  headerRow.appendChild(th);
                });
              thead.appendChild(headerRow);
              tbl.appendChild(thead);

              const tbody = document.createElement('tbody');
              top.forEach(r => {
                const tr = document.createElement('tr');
                [ r.date,
                  r.day,
                  r.endTime,
                  r.value.toLocaleString(undefined, {
                    minimumFractionDigits: 3,
                    maximumFractionDigits: 3
                  })
                ].forEach(txt => {
                  const td = document.createElement('td');
                  td.innerText = txt;
                  tr.appendChild(td);
                });
                tbody.appendChild(tr);
              });
              tbl.appendChild(tbody);
              container.appendChild(tbl);
            });

            document.getElementById('loading-pjm').style.display = 'none';
            document.getElementById('output-pjm').style.display = 'block';
          })
          .catch(e => {
            document.getElementById('loading-pjm').style.display = 'none';
            const err = document.getElementById('error-pjm');
            err.innerText = 'Error: ' + e.message;
            err.style.display = 'block';
          });
      })();

      // ERCOT Fetch (unchanged, delayed for rate limit), using interval_end_local and updating header
      setTimeout(() => {
        (function fetchERCOT() {
          const url =
            'https://api.gridstatus.io/v1/datasets/ercot_estimated_coincident_peak_load/query'
            + '?start_time=2025-06-01T01%3A00%3A00'
            + '&end_time=2025-10-01'
            + '&timezone=market';

          fetch(url, { headers: { 'x-api-key': API_KEY } })
            .then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); })
            .then(resp => {
              const arr = resp.data || [];
              arr.forEach(d => {
                d.cp = d.internal_generation
                     + d.dc_tie_imports
                     - d.dc_tie_exports
                     - d.wholesale_storage_load;
              });
              arr.sort((a,b) => b.cp - a.cp);

              const months = ['June 2025','July 2025','August 2025','September 2025'];
              const cont = document.getElementById('tables-ercot');
              cont.innerHTML = '';

              months.forEach(m => {
                const slice = arr.filter(d => {
                  const dt = new Date(d.interval_end_local);
                  return dt.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    year: 'numeric', month: 'long'
                  }) === m;
                }).slice(0,5);

                if (!slice.length) return;

                const h3 = document.createElement('h3');
                h3.innerText = m;
                cont.appendChild(h3);

                const tbl = document.createElement('table'),
                      thd = document.createElement('thead'),
                      hdr = document.createElement('tr');

                ['End Time (CT)','CP Load (MW)','Int. Gen (MW)','DC In (MW)','DC Out (MW)','WSL (MW)']
                  .forEach(t => {
                    const th = document.createElement('th');
                    th.innerText = t;
                    hdr.appendChild(th);
                  });

                thd.appendChild(hdr);
                tbl.appendChild(thd);

                const tbd = document.createElement('tbody');
                slice.forEach((d,i) => {
                  const tr = document.createElement('tr'),
                        bold = i === 0;
                  [
                    d.interval_end_local.replace('T',' ').slice(0,19),
                    d.cp, d.internal_generation,
                    d.dc_tie_imports, d.dc_tie_exports,
                    d.wholesale_storage_load
                  ].forEach(val => {
                    const td = document.createElement('td');
                    td.innerText = (typeof val === 'number')
                      ? val.toLocaleString(undefined, {
                          minimumFractionDigits: 3,
                          maximumFractionDigits: 3
                        })
                      : val;
                    if (bold) td.style.fontWeight = 'bold';
                    tr.appendChild(td);
                  });
                  tbd.appendChild(tr);
                });

                tbl.appendChild(tbd);
                cont.appendChild(tbl);
              });

              document.getElementById('loading-ercot').style.display = 'none';
              document.getElementById('output-ercot').style.display = 'block';
            })
            .catch(e => {
              document.getElementById('loading-ercot').style.display = 'none';
              const err = document.getElementById('error-ercot');
              err.innerText = 'Error: ' + e.message;
              err.style.display = 'block';
            });
        })();
      }, 1100);
    });
  </script>
</body>
</html>
